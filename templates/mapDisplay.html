{% extends 'base.html' %}
{% block content %}
    <div id="map"></div>

    <script>
      async function startApp() {
        try {
          // 1. Get data from your Python API
          const response = await fetch('/api/stores');
          const data = await response.json();
          
          const apiKey = data.apiKey;
          const stores = data.stores;

          // 2. Load Google Maps Script
          const script = document.createElement('script');
          script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&v=weekly`;
          script.async = true;
          document.head.appendChild(script);

          script.onload = () => {
            initMap(stores);
          };

        } catch (error) {
          console.error("Data fetch failed:", error);
        }
      }

      function initMap(stores) {
        // Default center (London) if GPS fails
        const map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 51.5074, lng: -0.1278 },
          zoom: 13,
        });

        // --- Handle User Location ---
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userPos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              
              console.log("User located at:", userPos);
              map.setCenter(userPos);

              // Add a special blue marker for the user
              new google.maps.Marker({
                position: userPos,
                map: map,
                title: "Your Location",
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 10,
                  fillColor: "#4285F4",
                  fillOpacity: 1,
                  strokeWeight: 2,
                  strokeColor: "white",
                }
              });
            },
            (error) => {
              console.warn("Geolocation error:", error.message);
            }
          );
        }

        // --- Add Store Markers ---
        stores.forEach(store => {
          if (store.lat && store.lng) {
            new google.maps.Marker({
              position: { lat: store.lat, lng: store.lng },
              map: map,
              title: store.name
            });
          }
        });
      }

      startApp();
    </script>

    <style>
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 84%; width: 100%; }
    </style>
{% endblock %}